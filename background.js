chrome.runtime.onInstalled.addListener(()=>{const menu=[['smartSave','Smart Save (fallback)','image']];for(const [id,title,ctx] of menu){try{chrome.contextMenus.create({id,title,contexts:[ctx]});}catch(e){}}});chrome.contextMenus.onClicked.addListener((info,tab)=>{if(info.menuItemId==='smartSave'){chrome.scripting.executeScript({target:{tabId:tab.id},func:(i)=>{ /* injected code */(async()=>{const src=i.srcUrl;const fname=prompt('Filename','image.png'); if(!fname)return;try{const h=await fetch(src,{method:'HEAD',mode:'no-cors'});if(h.ok){chrome.runtime.sendMessage({action:'directDownload',url:src,filename:fname});return;}}catch{}chrome.runtime.sendMessage({action:'screenshotVisible',filename:fname});})();},args:[info]});}});chrome.runtime.onMessage.addListener((msg,sender)=>{if(msg.action==='directDownload'){chrome.downloads.download({url:msg.url,filename:msg.filename});}if(msg.action==='screenshotVisible'){chrome.tabs.captureVisibleTab(sender.tab.windowId,{format:'png'},url=>{chrome.downloads.download({url,filename:msg.filename});});}});